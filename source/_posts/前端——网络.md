---
title: 前端——网络
date: 2018-07-19 16:20:00
tags:
    - 前端
    - js
    - http
    - tcp
---

## 强缓存与协商缓存

### 强缓存

1.  `Expires`：
    服务器返回的一个时间，在这个时间之前都使用缓存，不发送 `http` 请求。
    例如：`Expires: Thu, 10 Dec 2015 23:21:37 GMT`
    缺点：服务器的时间和客户端不同会出现问题，老版本 `http 1.0` 中才使用，现在一般使用 `Cache-Contorl`。
2.  `Cache-Control`(优先级高)：
    声明一个相对的秒数，表示从现在起一段时间内缓存都有效，也不会发送 `http` 请求。
    例如：`Cache-Control: max-age=3600`

<!-- more -->

### 协商缓存

1.  `Last-Modified` / `If-Modified-Since`:
    第一次请求一个资源时，服务器返回 `Last-Modified`(例如：`Last-Modified: Mon, 30 Nov 2015 23:21:37 GMT`)，下一次请求是客户端带上 `If-Modified-Since` 的 `header`，例如 `If-Modified-Since: Mon, 30 Nov 2015 23:21:37 GMT`，如果资源没改变则返回 `304` 状态码。
    缺点：服务器可能频繁修改文件（`ms`级），而 `Last-Modified` 只能精确到秒，可能返回错误的状态码(已经变动却返回相同的时间)；服务器修改了文件但是内容没变化，只是修改时间变了，这个时候其实是不用更新缓存的，故而 `ETag` 更好。
2.  `ETag` / `If-None-Match`(优先级高):
    用一个 `ETag` 标记服务器的文件(可以用 `hash` 之类的算法计算)，如果 `ETag` 没变则服务器返回 `304` 状态码。
    例如：服务器返回：`ETag: "d41d8cd98f00b204e9800998ecf8427e"`；客户端发送：`If-None-Match: W/"d41d8cd98f00b204e9800998ecf8427e"`

## TCP

### 三次握手建立连接

![TCP connect](/assets/img/tcp_connect.png)

1. 客户端请求建立 `TCP` 连接，标记 `SYN`(Synchronize Sequence Numbers，同步序列号) 为 `1`，并发送客户端的序列号 `x`，即 `SYN=1;seq=x`。发送完毕后，客户端进入 `SYN_SEND` 状态。
2. 服务器收到后，标记 `ACK`(Acknowledgement) 为 `1`，返回一个确认码 `ack`，值为客户端序列号加 `1`，并发送自己的同步序列号 `y` 给客户端，即 `SYN=1;seq=y;ACK=1;ack=x+1`。发送完毕后，服务器端进入 `SYN_RCVD` 状态，一段时间后没收到回复，自动尝试5次重新发送确认报文，每次时间间隔指数递增(1s,2s,4s,8s,16s)，第5次后等待 31s 后(总共63s)才能断开连接。
3. 客户端收到后需要告知服务器它收到了，同样发送确认码，即 `ACK=1;ack=y+1;seq=x+1`。发送完毕后，客户端进入 `ESTABLISHED` 状态，当服务器端接收到这个包时，也进入 `ESTABLISHED` 状态，TCP 握手结束。

> 注意：客户端发送每次 `TCP` 报文时 `seq` 都会递增 `1`，便于收到报文后确认报文发送的先后顺序。第三次握手不需要发送 `SYN=1` 信号，因为不是初始建立连接状态，如果标记为 `1` 那么服务器又会认为是建立一个新连接了。

### 四次握手关闭连接

![TCP finis](/assets/img/tcp_finish.png)


